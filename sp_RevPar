LTER PROC SP_Revpar
(
  @type int,--0:汇总；1：明细
    @lastBeginTime nvarchar(50),--上期开始时间
      @lastEndTime nvarchar(50), --上期结束时间
        @beginTime nvarchar(50),--本期开始时间
	  @endTime nvarchar(50),--本期结束时间
	    @storeIds nvarchar(255)--门店：如（0,98,99）
	    )
	    AS

	    DECLARE @strSQL NVARCHAR(MAX)

	    --0.创建临时表
	    DECLARE @tmp_table_RevparLast NVARCHAR(50)
	    SET @tmp_table_RevparLast='tmpLast'+REPLACE(REPLACE(REPLACE(REPLACE(CONVERT(varchar(100), GETDATE(), 121),'-',''),' ',''),':',''),'.','')
	    EXEC ('IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID('''+@tmp_table_RevparLast+''') AND type in (N''U''))
	           DROP TABLE '+@tmp_table_RevparLast+'')

		   DECLARE @tmp_table_Revpar NVARCHAR(50)
		   SET @tmp_table_Revpar='tmp'+REPLACE(REPLACE(REPLACE(REPLACE(CONVERT(varchar(100), GETDATE(), 121),'-',''),' ',''),':',''),'.','')
		   EXEC ('IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID('''+@tmp_table_Revpar+''') AND type in (N''U''))
		          DROP TABLE '+@tmp_table_Revpar+'')

			  DECLARE @tmp_table_RevparResult NVARCHAR(50)
			  SET @tmp_table_RevparResult='tmp'+REPLACE(REPLACE(REPLACE(REPLACE(CONVERT(varchar(100), GETDATE(), 121),'-',''),' ',''),':',''),'.','')
			  EXEC ('IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID('''+@tmp_table_RevparResult+''') AND type in (N''U''))
			         DROP TABLE '+@tmp_table_RevparResult+'')

				 --1.算出每个门店的收入，房间总数等信息，将数据存入临时表中
				 SET @strSQL=
				             'Select t1.StoreID,
					                         --上期实际总收
								                     SUM(ISNULL(t1.Amount,0)) + SUM(ISNULL(I.Amount,0)) + MAX(M.RentAmount) As InComeSum,
										                         --上期最新房间数
													                     (select case when COUNT(1)=0 then 0 else (select top 1 RoomNo from DailyStores 
															     					                                          where SynDate<='''+@lastEndTime+''' and StoreID=t1.StoreID order by SynDate desc) end RoomNo from DailyStores 
																									  					 where SynDate<='''+@lastEndTime+''' and StoreID=t1.StoreID) as RoomNo,
																														                     --上期房间总数
																																                         (select case when COUNT(1)=0 then 0 else (select sum(RoomNo) from DailyStores 
																																			 					                                          where SynDate between '''+@lastBeginTime+''' and '''+@lastEndTime+''' and StoreID=t1.StoreID group by StoreID) end from DailyStores 
																																													                      where SynDate between '''+@lastBeginTime+''' and '''+@lastEndTime+''' and StoreID=t1.StoreID group by StoreID) as RoomNoSum,
																																															                          --上期房间已租数
																																																		                      (select case when COUNT(1)=0 then 0 else (select sum(LeasedRoom) from DailyStores 
																																																				      					                                          where SynDate between '''+@lastBeginTime+''' and '''+@lastEndTime+''' and StoreID=t1.StoreID group by StoreID) end from DailyStores 
																																																														                      where SynDate between '''+@lastBeginTime+''' and '''+@lastEndTime+''' and StoreID=t1.StoreID group by StoreID) as LeasedRoomSum,
																																																																                          --净租金
																																																																			                      MAX(M.RentAmount) as LastNetRentIncome,
																																																																					                          --违约金
																																																																								                     (select isnull(sum(Amount),0) from PaymentMethods left join Charges on PaymentMethods.ID=Charges.PaymentMethodID 
																																																																										     				                                                     left join Contracts on Contracts.ID=Charges.ContractID 
																																																																																				     																	 left join Rooms on Rooms.ID=Contracts.RoomID 
																																																																																																					 												  where PaymentMethods.Date between '''+@lastBeginTime+''' and '''+@lastEndTime+''' and Rooms.StoreID=t1.StoreID 
																																																																																																																	  												        and Charges.FeeType in (''14'') and  PaymentMethods.Status=2) as LastDefaultIncome
																																																																																																																														            Into '+@tmp_table_RevparLast+'
																																																																																																																															                From PaymentMethods As D 
																																																																																																																																	            --门店收费(包含预约)
																																																																																																																																		                Left Join (select Amount,PaymentMethodID from StoreCharges) As I On I.PaymentMethodID=D.ID
																																																																																																																																				            Left Join (
																																																																																																																																					    						--预定 
																																																																																																																																																	select Rooms.StoreID,ReservationCharges.Status,ReservationCharges.PaymentMethodID,ReservationCharges.Amount 
																																																																																																																																																							from ReservationCharges left join Reservations on Reservations.ID=ReservationCharges.ReservationID 
																																																																																																																																																													                        left join Rooms on Rooms.ID=Reservations.RoomID
																																																																																																																																																																						union all
																																																																																																																																																																												--一次性收费
																																																																																																																																																																																		select Rooms.StoreID,Charges.Status,Charges.PaymentMethodID,Charges.Amount 
																																																																																																																																																																																								from Charges left join Contracts on Charges.ContractID=Contracts.ID left join Rooms on Rooms.ID=Contracts.RoomID  
																																																																																																																																																																																														where FeeType!=1
																																																																																																																																																																																																	          ) as t1 on D.ID=t1.PaymentMethodID
																																																																																																																																																																																																		             Left Join (select StoreID,ISNULL(SUM(a.Amount),0) as RentAmount from DailyRentApportion as a left join Rooms as b on  a.RoomID=b.ID 
																																																																																																																																																																																																			     		              where a.Type=31  and a.Date between  '''+@lastBeginTime+''' and '''+@lastEndTime+''' group by b.StoreID) as M On M.StoreID=t1.StoreID
																																																																																																																																																																																																						                 Where  D.Date Between '''+@lastBeginTime+''' and '''+@lastEndTime+'''  And D.Status=2
																																																																																																																																																																																																								            Group By t1.StoreID'
																																																																																																																																																																																																									    EXEC(@strSQL)

																																																																																																																																																																																																									    SET @strSQL=
																																																																																																																																																																																																									                'Select t1.StoreID,
																																																																																																																																																																																																											                    --实际总收
																																																																																																																																																																																																													                        SUM(ISNULL(t1.Amount,0)) + SUM(ISNULL(I.Amount,0)) + MAX(M.RentAmount) As InComeSum,
																																																																																																																																																																																																																                    --最新房间数
																																																																																																																																																																																																																		                        (select case when COUNT(1)=0 then 0 else (select top 1 RoomNo from DailyStores 
																																																																																																																																																																																																																										                                          where SynDate<='''+@endTime+''' and StoreID=t1.StoreID order by SynDate desc) end RoomNo from DailyStores 
																																																																																																																																																																																																																															  					 where SynDate<='''+@endTime+''' and StoreID=t1.StoreID) as RoomNo,
																																																																																																																																																																																																																																				                     --房间总数
																																																																																																																																																																																																																																						                         (select case when COUNT(1)=0 then 0 else (select sum(RoomNo) from DailyStores 
																																																																																																																																																																																																																																									 					                                          where SynDate between '''+@beginTime+''' and '''+@endTime+''' and StoreID=t1.StoreID group by StoreID) end from DailyStores 
																																																																																																																																																																																																																																																			                      where SynDate between '''+@beginTime+''' and '''+@endTime+''' and StoreID=t1.StoreID group by StoreID) as RoomNoSum,
																																																																																																																																																																																																																																																					                          --房间已租数
																																																																																																																																																																																																																																																								                      (select case when COUNT(1)=0 then 0 else (select sum(LeasedRoom) from DailyStores 
																																																																																																																																																																																																																																																										      					                                          where SynDate between '''+@beginTime+''' and '''+@endTime+''' and StoreID=t1.StoreID group by StoreID) end from DailyStores 
																																																																																																																																																																																																																																																																				                      where SynDate between '''+@beginTime+''' and '''+@endTime+''' and StoreID=t1.StoreID group by StoreID) as LeasedRoomSum,
																																																																																																																																																																																																																																																																						                          --净租金
																																																																																																																																																																																																																																																																									                      MAX(M.RentAmount) as NetRentIncome,
																																																																																																																																																																																																																																																																											                          --违约金
																																																																																																																																																																																																																																																																														                     (select isnull(sum(Amount),0) from PaymentMethods left join Charges on PaymentMethods.ID=Charges.PaymentMethodID 
																																																																																																																																																																																																																																																																																     				                                                     left join Contracts on Contracts.ID=Charges.ContractID 
																																																																																																																																																																																																																																																																																										     																	 left join Rooms on Rooms.ID=Contracts.RoomID 
																																																																																																																																																																																																																																																																																																											 												  where PaymentMethods.Date between '''+@beginTime+''' and '''+@endTime+''' and Rooms.StoreID=t1.StoreID 
																																																																																																																																																																																																																																																																																																																							  												        and Charges.FeeType in (''14'') and  PaymentMethods.Status=2) as DefaultIncome
																																																																																																																																																																																																																																																																																																																																				            Into '+@tmp_table_Revpar+'
																																																																																																																																																																																																																																																																																																																																					                From PaymentMethods As D 
																																																																																																																																																																																																																																																																																																																																							            --门店收费(包含预约)
																																																																																																																																																																																																																																																																																																																																								                Left Join (select Amount,PaymentMethodID from StoreCharges) As I On I.PaymentMethodID=D.ID
																																																																																																																																																																																																																																																																																																																																										            Left Join (
																																																																																																																																																																																																																																																																																																																																											    						--预定 
																																																																																																																																																																																																																																																																																																																																																							select Rooms.StoreID,ReservationCharges.Status,ReservationCharges.PaymentMethodID,ReservationCharges.Amount 
																																																																																																																																																																																																																																																																																																																																																													from ReservationCharges left join Reservations on Reservations.ID=ReservationCharges.ReservationID 
																																																																																																																																																																																																																																																																																																																																																																			                        left join Rooms on Rooms.ID=Reservations.RoomID
																																																																																																																																																																																																																																																																																																																																																																												union all
																																																																																																																																																																																																																																																																																																																																																																																		--一次性收费
																																																																																																																																																																																																																																																																																																																																																																																								select Rooms.StoreID,Charges.Status,Charges.PaymentMethodID,Charges.Amount 
																																																																																																																																																																																																																																																																																																																																																																																														from Charges left join Contracts on Charges.ContractID=Contracts.ID left join Rooms on Rooms.ID=Contracts.RoomID  
																																																																																																																																																																																																																																																																																																																																																																																																				where FeeType!=1
																																																																																																																																																																																																																																																																																																																																																																																																							          ) as t1 on D.ID=t1.PaymentMethodID
																																																																																																																																																																																																																																																																																																																																																																																																								             Left Join (select StoreID,ISNULL(SUM(a.Amount),0) as RentAmount from DailyRentApportion as a left join Rooms as b on  a.RoomID=b.ID 
																																																																																																																																																																																																																																																																																																																																																																																																									     		              where a.Type=31  and a.Date between  '''+@beginTime+''' and '''+@endTime+''' group by b.StoreID) as M On M.StoreID=t1.StoreID
																																																																																																																																																																																																																																																																																																																																																																																																												                 Where  D.Date Between '''+@beginTime+''' and '''+@endTime+'''  And D.Status=2
																																																																																																																																																																																																																																																																																																																																																																																																														            Group By t1.StoreID'
																																																																																																																																																																																																																																																																																																																																																																																																															    EXEC(@strSQL)

																																																																																																																																																																																																																																																																																																																																																																																																															    --2.根据不同的type关联临时表获取结果集
																																																																																																																																																																																																																																																																																																																																																																																																															    DECLARE @strSQL1 NVARCHAR(MAX)
																																																																																																																																																																																																																																																																																																																																																																																																															    IF @type=0
																																																																																																																																																																																																																																																																																																																																																																																																															    BEGIN

																																																																																																																																																																																																																																																																																																																																																																																																															    SET @strSQL=
																																																																																																																																																																																																																																																																																																																																																																																																															        'SELECT 
																																																																																																																																																																																																																																																																																																																																																																																																																	 A.ID AS Sort,
																																																																																																																																																																																																																																																																																																																																																																																																																	 	 A.CityName AS [StoreName],
																																																																																																																																																																																																																																																																																																																																																																																																																		 	 A.CityCode AS StoreCode,
																																																																																																																																																																																																																																																																																																																																																																																																																			 	 SUM(ISNULL(E.RoomNo,0)) AS [RoomCount],
																																																																																																																																																																																																																																																																																																																																																																																																																				 	 SUM(ISNULL(D.InComeSum,0)) AS [LastRealRentSum],
																																																																																																																																																																																																																																																																																																																																																																																																																					      SUM(ISNULL(E.InComeSum,0)) AS [RealRentSum],
																																																																																																																																																																																																																																																																																																																																																																																																																					      	 CASE WHEN SUM(D.InComeSum)=0 THEN '''' ELSE  CONVERT(NVARCHAR(30),CAST(ROUND((SUM(E.InComeSum)-SUM(D.InComeSum))*100.0/SUM(D.InComeSum),2) AS NUMERIC(18,2)))+''%'' END AS RealIncomeMom,
																																																																																																																																																																																																																																																																																																																																																																																																																						 	 CASE WHEN SUM(D.RoomNo)=0 THEN 0 ELSE CAST(ROUND(SUM(D.LastNetRentIncome)/SUM(D.RoomNo),0) AS NUMERIC(18,0)) END AS LastRevpar,
																																																																																																																																																																																																																																																																																																																																																																																																																							 	 CASE WHEN SUM(E.RoomNo)=0 THEN 0 ELSE CAST(ROUND(SUM(E.NetRentIncome)/SUM(E.RoomNo),0) AS NUMERIC(18,0)) END AS Revpar,
																																																																																																																																																																																																																																																																																																																																																																																																																								 	 CASE WHEN SUM(D.RoomNo)=0 THEN '''' WHEN SUM(E.RoomNo)=0 THEN '''' ELSE (CASE WHEN SUM(D.InComeSum)/SUM(D.RoomNo)=0 THEN '''' ELSE CONVERT(NVARCHAR(30),CAST(ROUND((SUM(E.InComeSum)/SUM(E.RoomNo)-SUM(D.InComeSum)/SUM(D.RoomNo))*100.0/(SUM(D.InComeSum)/SUM(D.RoomNo)),2) AS NUMERIC(18,2)))+''%'' END) END AS RevparMom,
																																																																																																																																																																																																																																																																																																																																																																																																																									 	 CASE WHEN SUM(D.RoomNoSum)=0 THEN '''' ELSE  CONVERT(NVARCHAR(30),CAST(ROUND(SUM(D.LeasedRoomSum)*100.0/SUM(D.RoomNoSum),2) AS NUMERIC(18,2))) END AS LastRealRentRate,
																																																																																																																																																																																																																																																																																																																																																																																																																										 	 CASE WHEN SUM(E.RoomNoSum)=0 THEN '''' ELSE  CONVERT(NVARCHAR(30),CAST(ROUND(SUM(E.LeasedRoomSum)*100.0/SUM(E.RoomNoSum),2) AS NUMERIC(18,2))) END AS RealRentRate,
																																																																																																																																																																																																																																																																																																																																																																																																																											      (Select SUM(CharterMoney)  From ContractFees Where ContractID In (select distinct ContractID from ContractOps  left join Contracts on ContractOps.ContractID=Contracts.ID LEFT JOIN Rooms ON Contracts.RoomID=Rooms.ID LEFT JOIN Stores ON Rooms.StoreID=Stores.ID LEFT JOIN Items ON Stores.ItemID=Items.Id LEFT JOIN Cities ON Items.CityID=Cities.ID where Cities.ID=A.Id AND  ContractOps.CreateDate between '''+@lastBeginTime+''' and '''+@lastEndTime+''')) AS LastRealRoomFee,
																																																																																																																																																																																																																																																																																																																																																																																																																											           (Select Isnull(SUM(case when SpecialRooms.RoomID is null then 1 else SpecialRooms.BigRoomCount end),0) From Contracts Left Join Rooms on Contracts.RoomID=Rooms.ID LEFT JOIN Stores ON Rooms.StoreID=Stores.ID LEFT JOIN Items ON Stores.ItemID=Items.Id LEFT JOIN Cities ON Items.CityID=Cities.ID  Left Join (SELECT ProRoomID as RoomID,COUNT(1) as BigRoomCount  FROM ContractForRooms  WHERE ContractID IS NOT NULL GROUP BY ProRoomID,ContractID) SpecialRooms on SpecialRooms.RoomID=Rooms.ID  Where Cities.ID=A.Id AND  Contracts.ID In (select distinct ContractID from ContractOps  left join Contracts on ContractOps.ContractID=Contracts.ID where  ContractOps.CreateDate between '''+@lastBeginTime+''' and '''+@lastEndTime+''')) AS LastRealContractCount,
																																																																																																																																																																																																																																																																																																																																																																																																																												   	 (Select SUM(CharterMoney)  From ContractFees Where ContractID In (select distinct ContractID from ContractOps  left join Contracts on ContractOps.ContractID=Contracts.ID LEFT JOIN Rooms ON Contracts.RoomID=Rooms.ID LEFT JOIN Stores ON Rooms.StoreID=Stores.ID LEFT JOIN Items ON Stores.ItemID=Items.Id LEFT JOIN Cities ON Items.CityID=Cities.ID where Cities.ID=A.Id AND   ContractOps.CreateDate between '''+@beginTime+''' and '''+@endTime+''')) AS RealRoomFee,
																																																																																																																																																																																																																																																																																																																																																																																																																													      (Select Isnull(SUM(case when SpecialRooms.RoomID is null then 1 else SpecialRooms.BigRoomCount end),0) From Contracts Left Join Rooms on Contracts.RoomID=Rooms.ID LEFT JOIN Stores ON Rooms.StoreID=Stores.ID LEFT JOIN Items ON Stores.ItemID=Items.Id LEFT JOIN Cities ON Items.CityID=Cities.ID  Left Join (SELECT ProRoomID as RoomID,COUNT(1) as BigRoomCount  FROM ContractForRooms  WHERE ContractID IS NOT NULL GROUP BY ProRoomID,ContractID) SpecialRooms on SpecialRooms.RoomID=Rooms.ID  Where Cities.ID=A.Id AND  Contracts.ID In (select distinct ContractID from ContractOps  left join Contracts on ContractOps.ContractID=Contracts.ID where  ContractOps.CreateDate between '''+@beginTime+''' and '''+@endTime+''')) AS RealContractCount,'
																																																																																																																																																																																																																																																																																																																																																																																																																													      SET @strSQL1='
																																																																																																																																																																																																																																																																																																																																																																																																																													      	 SUM(D.LastNetRentIncome) AS LastNetRentIncome,
																																																																																																																																																																																																																																																																																																																																																																																																																														 	 SUM(E.NetRentIncome) AS NetRentIncome,
																																																																																																																																																																																																																																																																																																																																																																																																																															 	 CASE WHEN SUM(D.LastNetRentIncome)=0 THEN '''' ELSE CONVERT(NVARCHAR(30),CAST(ROUND((SUM(E.NetRentIncome)-SUM(D.LastNetRentIncome))*100.0/SUM(D.LastNetRentIncome),2) AS NUMERIC(18,2)))+''%'' END AS NetRentIncomeMom,
																																																																																																																																																																																																																																																																																																																																																																																																																																 	 SUM(D.LastDefaultIncome) AS LastDefaultIncome,
																																																																																																																																																																																																																																																																																																																																																																																																																																	 	 SUM(E.DefaultIncome) AS DefaultIncome,
																																																																																																																																																																																																																																																																																																																																																																																																																																		 	 CASE WHEN SUM(D.LastDefaultIncome)=0 THEN '''' ELSE CONVERT(NVARCHAR(30),CAST(ROUND((SUM(E.DefaultIncome)-SUM(D.LastDefaultIncome))*100.0/SUM(D.LastDefaultIncome),2) AS NUMERIC(18,2)))+''%'' END AS DefaultIncomeMom
																																																																																																																																																																																																																																																																																																																																																																																																																																			 	 INTO '+@tmp_table_RevparResult+'
																																																																																																																																																																																																																																																																																																																																																																																																																																				 	 FROM Cities AS A
																																																																																																																																																																																																																																																																																																																																																																																																																																					 	 INNER JOIN Items AS B ON B.CityID=A.Id
																																																																																																																																																																																																																																																																																																																																																																																																																																						 	 INNER JOIN Stores AS C ON C.ItemID=B.Id
																																																																																																																																																																																																																																																																																																																																																																																																																																							      LEFT JOIN '+@tmp_table_RevparLast+' AS D ON C.ID=D.StoreID
																																																																																																																																																																																																																																																																																																																																																																																																																																							      	 LEFT JOIN '+@tmp_table_Revpar+' AS E ON C.ID=E.StoreID 
																																																																																																																																																																																																																																																																																																																																																																																																																																								 	 GROUP BY A.ID,A.CityCode,A.CityName' 
																																																																																																																																																																																																																																																																																																																																																																																																																																									 EXEC(@strSQL+@strSQL1)
																																																																																																																																																																																																																																																																																																																																																																																																																																									  
																																																																																																																																																																																																																																																																																																																																																																																																																																									  END
																																																																																																																																																																																																																																																																																																																																																																																																																																									  ELSE 
																																																																																																																																																																																																																																																																																																																																																																																																																																									  BEGIN
																																																																																																																																																																																																																																																																																																																																																																																																																																									      
																																																																																																																																																																																																																																																																																																																																																																																																																																									      SET @strSQL=
																																																																																																																																																																																																																																																																																																																																																																																																																																									          'SELECT 
																																																																																																																																																																																																																																																																																																																																																																																																																																										  	 B.Id AS [Sort],
																																																																																																																																																																																																																																																																																																																																																																																																																																											 	 A.ID AS [StoreCode],
																																																																																																																																																																																																																																																																																																																																																																																																																																												 	 A.Name AS [StoreName],
																																																																																																																																																																																																																																																																																																																																																																																																																																													 	 SUM(ISNULL(E.RoomNo,0)) AS [RoomCount],
																																																																																																																																																																																																																																																																																																																																																																																																																																														 	 SUM(ISNULL(D.InComeSum,0)) AS [LastRealRentSum],
																																																																																																																																																																																																																																																																																																																																																																																																																																															      SUM(ISNULL(E.InComeSum,0)) AS [RealRentSum],
																																																																																																																																																																																																																																																																																																																																																																																																																																															      	 CASE WHEN SUM(D.InComeSum)=0 THEN '''' ELSE  CONVERT(NVARCHAR(30),CAST(ROUND((SUM(E.InComeSum)-SUM(D.InComeSum))*100.0/SUM(D.InComeSum),2) AS NUMERIC(18,2)))+''%'' END AS RealIncomeMom,
																																																																																																																																																																																																																																																																																																																																																																																																																																																 	 CASE WHEN SUM(D.RoomNo)=0 THEN 0 ELSE CAST(ROUND(SUM(D.LastNetRentIncome)/SUM(D.RoomNo),0) AS NUMERIC(18,0)) END AS LastRevpar,
																																																																																																																																																																																																																																																																																																																																																																																																																																																	 	 CASE WHEN SUM(E.RoomNo)=0 THEN 0 ELSE CAST(ROUND(SUM(E.NetRentIncome)/SUM(E.RoomNo),0) AS NUMERIC(18,0)) END AS Revpar,
																																																																																																																																																																																																																																																																																																																																																																																																																																																		 	 CASE WHEN SUM(D.RoomNo)=0 THEN '''' WHEN SUM(E.RoomNo)=0 THEN '''' ELSE (CASE WHEN SUM(D.InComeSum)/SUM(D.RoomNo)=0 THEN '''' ELSE CONVERT(NVARCHAR(30),CAST(ROUND((SUM(E.InComeSum)/SUM(E.RoomNo)-SUM(D.InComeSum)/SUM(D.RoomNo))*100.0/(SUM(D.InComeSum)/SUM(D.RoomNo)),2) AS NUMERIC(18,2)))+''%'' END) END AS RevparMom,
																																																																																																																																																																																																																																																																																																																																																																																																																																																			 	 CASE WHEN SUM(D.RoomNoSum)=0 THEN '''' ELSE  CONVERT(NVARCHAR(30),CAST(ROUND(SUM(D.LeasedRoomSum)*100.0/SUM(D.RoomNoSum),2) AS NUMERIC(18,2))) END AS LastRealRentRate,
																																																																																																																																																																																																																																																																																																																																																																																																																																																				 	 CASE WHEN SUM(E.RoomNoSum)=0 THEN '''' ELSE  CONVERT(NVARCHAR(30),CAST(ROUND(SUM(E.LeasedRoomSum)*100.0/SUM(E.RoomNoSum),2) AS NUMERIC(18,2))) END AS RealRentRate,
																																																																																																																																																																																																																																																																																																																																																																																																																																																					      (Select SUM(CharterMoney)  From ContractFees Where ContractID In (select distinct ContractID from ContractOps  left join Contracts on ContractOps.ContractID=Contracts.ID LEFT JOIN Rooms ON Contracts.RoomID=Rooms.ID LEFT JOIN Stores ON Rooms.StoreID=Stores.ID LEFT JOIN Items ON Stores.ItemID=Items.Id LEFT JOIN Cities ON Items.CityID=Cities.ID where Cities.ID=A.Id AND  ContractOps.CreateDate between '''+@lastBeginTime+''' and '''+@lastEndTime+''')) AS LastRealRoomFee,
																																																																																																																																																																																																																																																																																																																																																																																																																																																					           (Select Isnull(SUM(case when SpecialRooms.RoomID is null then 1 else SpecialRooms.BigRoomCount end),0) From Contracts Left Join Rooms on Contracts.RoomID=Rooms.ID LEFT JOIN Stores ON Rooms.StoreID=Stores.ID LEFT JOIN Items ON Stores.ItemID=Items.Id LEFT JOIN Cities ON Items.CityID=Cities.ID  Left Join (SELECT ProRoomID as RoomID,COUNT(1) as BigRoomCount  FROM ContractForRooms  WHERE ContractID IS NOT NULL GROUP BY ProRoomID,ContractID) SpecialRooms on SpecialRooms.RoomID=Rooms.ID  Where Cities.ID=A.Id AND  Contracts.ID In (select distinct ContractID from ContractOps  left join Contracts on ContractOps.ContractID=Contracts.ID where  ContractOps.CreateDate between '''+@lastBeginTime+''' and '''+@lastEndTime+''')) AS LastRealContractCount,
																																																																																																																																																																																																																																																																																																																																																																																																																																																						   	 (Select SUM(CharterMoney)  From ContractFees Where ContractID In (select distinct ContractID from ContractOps  left join Contracts on ContractOps.ContractID=Contracts.ID LEFT JOIN Rooms ON Contracts.RoomID=Rooms.ID LEFT JOIN Stores ON Rooms.StoreID=Stores.ID LEFT JOIN Items ON Stores.ItemID=Items.Id LEFT JOIN Cities ON Items.CityID=Cities.ID where Cities.ID=A.Id AND   ContractOps.CreateDate between '''+@beginTime+''' and '''+@endTime+''')) AS RealRoomFee,
																																																																																																																																																																																																																																																																																																																																																																																																																																																							      (Select Isnull(SUM(case when SpecialRooms.RoomID is null then 1 else SpecialRooms.BigRoomCount end),0) From Contracts Left Join Rooms on Contracts.RoomID=Rooms.ID LEFT JOIN Stores ON Rooms.StoreID=Stores.ID LEFT JOIN Items ON Stores.ItemID=Items.Id LEFT JOIN Cities ON Items.CityID=Cities.ID  Left Join (SELECT ProRoomID as RoomID,COUNT(1) as BigRoomCount  FROM ContractForRooms  WHERE ContractID IS NOT NULL GROUP BY ProRoomID,ContractID) SpecialRooms on SpecialRooms.RoomID=Rooms.ID  Where Cities.ID=A.Id AND  Contracts.ID In (select distinct ContractID from ContractOps  left join Contracts on ContractOps.ContractID=Contracts.ID where  ContractOps.CreateDate between '''+@beginTime+''' and '''+@endTime+''')) AS RealContractCount,'
																																																																																																																																																																																																																																																																																																																																																																																																																																																							      SET @strSQL1='
																																																																																																																																																																																																																																																																																																																																																																																																																																																							      	 SUM(D.LastNetRentIncome) AS LastNetRentIncome,
																																																																																																																																																																																																																																																																																																																																																																																																																																																								 	 SUM(E.NetRentIncome) AS NetRentIncome,
																																																																																																																																																																																																																																																																																																																																																																																																																																																									 	 CASE WHEN SUM(D.LastNetRentIncome)=0 THEN '''' ELSE CONVERT(NVARCHAR(30),CAST(ROUND((SUM(E.NetRentIncome)-SUM(D.LastNetRentIncome))*100.0/SUM(D.LastNetRentIncome),2) AS NUMERIC(18,2)))+''%'' END AS NetRentIncomeMom,
																																																																																																																																																																																																																																																																																																																																																																																																																																																										 	 SUM(D.LastDefaultIncome) AS LastDefaultIncome,
																																																																																																																																																																																																																																																																																																																																																																																																																																																											 	 SUM(E.DefaultIncome) AS DefaultIncome,
																																																																																																																																																																																																																																																																																																																																																																																																																																																												 	 CASE WHEN SUM(D.LastDefaultIncome)=0 THEN '''' ELSE CONVERT(NVARCHAR(30),CAST(ROUND((SUM(E.DefaultIncome)-SUM(D.LastDefaultIncome))*100.0/SUM(D.LastDefaultIncome),2) AS NUMERIC(18,2)))+''%'' END AS DefaultIncomeMom
																																																																																																																																																																																																																																																																																																																																																																																																																																																													 	 INTO '+@tmp_table_RevparResult+'
																																																																																																																																																																																																																																																																																																																																																																																																																																																														 	 FROM Stores AS A LEFT JOIN Items AS B ON A.ItemID=B.Id
																																																																																																																																																																																																																																																																																																																																																																																																																																																															      LEFT JOIN '+@tmp_table_RevparLast+' AS D ON A.ID=D.StoreID
																																																																																																																																																																																																																																																																																																																																																																																																																																																															      	 LEFT JOIN '+@tmp_table_Revpar+' AS E ON A.ID=E.StoreID
																																																																																																																																																																																																																																																																																																																																																																																																																																																																 	 WHERE A.ID IN ('+@storeIds+') 
																																																																																																																																																																																																																																																																																																																																																																																																																																																																	 	 GROUP BY B.Id,A.ID,A.Name' 
																																																																																																																																																																																																																																																																																																																																																																																																																																																																		 EXEC(@strSQL+@strSQL1)
																																																																																																																																																																																																																																																																																																																																																																																																																																																																		  
																																																																																																																																																																																																																																																																																																																																																																																																																																																																		  END

																																																																																																																																																																																																																																																																																																																																																																																																																																																																		  --3.获取最终结果集
																																																																																																																																																																																																																																																																																																																																																																																																																																																																		  SET @strSQL='SELECT 
																																																																																																																																																																																																																																																																																																																																																																																																																																																																		                  t.Sort AS [Sort],
																																																																																																																																																																																																																																																																																																																																																																																																																																																																				  				t.StoreCode AS [StoreCode],
																																																																																																																																																																																																																																																																																																																																																																																																																																																																												t.StoreName AS [StoreName],
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																ISNULL(t.RoomCount,0) AS [RoomCount],
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																				ISNULL(t.LastRealRentSum,0) AS [RoomCount],
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								ISNULL(t.RealRentSum,0) AS [RealRentSum],
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																												ISNULL(t.RealIncomeMom,'''') AS [RealIncomeMom],
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																ISNULL(t.LastRevpar,0) AS [LastRevpar],
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																				ISNULL(t.Revpar,0) AS [Revpar],
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								ISNULL(t.RevparMom,'''') AS [RevparMom],
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																												CASE WHEN ISNULL(t.LastRealRentRate,'''')='''' THEN '''' ELSE t.LastRealRentRate+''%'' END as [LastRealRentRate],
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																CASE WHEN ISNULL(t.RealRentRate,'''')='''' THEN '''' ELSE t.RealRentRate+''%'' END as [RealRentRate],
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																				(case when ISNULL(t.LastRealRentRate,'''')='''' then '''' else convert(nvarchar(30),cast(round((convert(decimal(18,2),t.RealRentRate)-convert(decimal(18,2),t.LastRealRentRate))*100.0/t.LastRealRentRate,2) AS NUMERIC(18,2)))+''%'' end) as [RealRentRateMom],
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								CAST((case when t.LastRealContractCount=0 then 0 else t.LastRealRoomFee/t.LastRealContractCount end) as decimal(18,0))  as [LastRealArgRoomPrice],
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																												CAST((case when t.RealContractCount=0 then 0 else t.RealRoomFee/t.RealContractCount end) as decimal(18,0))  as [RealArgRoomPrice],
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																(case when CAST((case when t.LastRealContractCount=0 then 0 else t.LastRealRoomFee/t.LastRealContractCount end) as decimal(18,0))=0 then '''' else convert(nvarchar(30),cast(round((convert(decimal(18,2),CAST((case when t.RealContractCount=0 then 0 else t.RealRoomFee/t.RealContractCount end) as decimal(18,0)))-convert(decimal(18,2),CAST((case when t.LastRealContractCount=0 then 0 else t.LastRealRoomFee/t.LastRealContractCount end) as decimal(18,0))))*100.0/CAST((case when t.LastRealContractCount=0 then 0 else t.LastRealRoomFee/t.LastRealContractCount end) as decimal(18,0)),2) AS NUMERIC(18,2)))+''%'' end) as [RealArgRoomPriceMom],
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																				ISNULL(t.LastNetRentIncome,0) AS [LastNetRentIncome],
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								ISNULL(t.NetRentIncome,0) AS [NetRentIncome],
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																												ISNULL(t.NetRentIncomeMom,'''') AS [NetRentIncomeMom],
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																ISNULL(t.LastDefaultIncome,0) AS [LastDefaultIncome],
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																				ISNULL(t.DefaultIncome,0) AS [DefaultIncome],
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								ISNULL(t.DefaultIncomeMom,'''') AS [DefaultIncomeMom]
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								             FROM '+@tmp_table_RevparResult+' AS t
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																									     			 WHERE t.RoomCount>0'


																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																												 EXEC(@strSQL)

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																												 --4.删除临时表
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																												 EXEC ('IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID('''+@tmp_table_RevparLast+''') AND type in (N''U''))
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																												        DROP TABLE '+@tmp_table_RevparLast+'')

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																													EXEC ('IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID('''+@tmp_table_Revpar+''') AND type in (N''U''))
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																													       DROP TABLE '+@tmp_table_Revpar+'')

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																													       EXEC ('IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID('''+@tmp_table_RevparResult+''') AND type in (N''U''))
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																													              DROP TABLE '+@tmp_table_RevparResult+'')

																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																														      GO

